<!--
    Author - Ivan Liljeqvist
    Version - 10-05-2015

    Spotify redirects the user to this page when the login is complete.

    If the user information is not passed by GET to this page, we get the user inforation 
    with JS function getUserData and send it to this same page.

    If the user information is passed by GET we create a user_info.txt file with the information.

-->
<html>

<head>

<!-- Get jQuery -->

<script src="http://code.jquery.com/jquery-latest.min.js"
        type="text/javascript"></script>

<script>


/*
    Get's the hash parameters from the current URL.
*/

function getHashParams() {

    var hashParams = {};
    var e,
        a = /\+/g,  // Regex for replacing addition symbol with a space
        r = /([^&;=]+)=?([^&;]*)/g,
        d = function (s) { return decodeURIComponent(s.replace(a, " ")); },
        q = window.location.hash.substring(1);

    while (e = r.exec(q))
       hashParams[d(e[1])] = d(e[2]);

    return hashParams;
}

/*
    Give it a accessToken generated by Spotify and you'll receive the user information
    associated with that accessToken.
*/

function getUserData(accessToken) {
        return $.ajax({
            url: 'https://api.spotify.com/v1/me',
            headers: {
               'Authorization': 'Bearer ' + accessToken
            }
        });
}
</script>

</head>

<body>



<?php 
//if the user_id and email is not set - fetch and send to this page again
if(!isset($_GET['user_id']) and !isset($_GET['email'])){


?>

    <!--
        Get the user information by extracting the accessToken from the URL.
        Go to results.php (this file), but pass in user information as GET parametes.
    -->
	<script type="text/javascript">
		getUserData(getHashParams()["access_token"])
		                .then(function(response) {
		                    location.replace("http://simkoll.com/muzikk/result.php?user_id="+response["id"]+"&email="+response["email"]);
		                });
	</script>

<?php
}
//if email and user id are set - save in a file
else{
    //clean up previous logged in users.
	unlink('user_info.txt');

    //create a new file
	$userInfoFile = fopen("user_info.txt", "w") or die("can't open file");
    //construct a string with user information.
	$txt = $_GET['user_id']." ".$_GET['email'];
    //write the info to the file.
	fwrite($userInfoFile, $txt) or die("can't write file");
    //close the file.
	fclose($userInfoFile);


    //We're done! the user is logged in!
    
    //Print a message to the user.
	echo "GO BACK TO MUZIKK";
}
?>




</body>

</html>